-- =============================================================================
-- Supabase Schema: Starter Club Forms
-- Generated by AI Agent | Best Practices Edition
-- =============================================================================

-- Enable UUID extension if not already enabled
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =============================================================================
-- 1. ENUM TYPES
-- Replace boolean flags with meaningful status states
-- =============================================================================

-- Status for Waitlist Submissions
DO $$ BEGIN
    CREATE TYPE waitlist_status AS ENUM ('pending', 'approved', 'waitlisted', 'contacted', 'archived');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- Status for Partner Inquiries
DO $$ BEGIN
    CREATE TYPE inquiry_status AS ENUM ('new', 'viewed', 'contacted', 'converted', 'rejected');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- Source of the submission (e.g., specific form variant)
DO $$ BEGIN
    CREATE TYPE submission_source AS ENUM ('main_form', 'modal_popup', 'other');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- =============================================================================
-- 2. UTILITY FUNCTIONS
-- =============================================================================

-- Function to automatically update 'updated_at' timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = now();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- =============================================================================
-- 3. TABLES
-- =============================================================================

-- -----------------------------------------------------------------------------
-- Table: waitlist_submissions
-- Consolidates data from WaitlistForm.tsx and WaitlistModal.tsx
-- -----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS waitlist_submissions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Contact Info
    email TEXT NOT NULL,
    full_name TEXT NOT NULL,
    phone TEXT, -- Captured in Modal
    
    -- Context
    project_idea TEXT, -- Captured in Main Form ('identity')
    
    -- Metadata
    source submission_source DEFAULT 'other',
    status waitlist_status NOT NULL DEFAULT 'pending',
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),

    -- Constraints
    CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- Index for faster filtering by status and email lookups
CREATE INDEX IF NOT EXISTS idx_waitlist_status ON waitlist_submissions(status);
CREATE INDEX IF NOT EXISTS idx_waitlist_email ON waitlist_submissions(email);

-- Trigger for updated_at
DROP TRIGGER IF EXISTS update_waitlist_modtime ON waitlist_submissions;
CREATE TRIGGER update_waitlist_modtime
    BEFORE UPDATE ON waitlist_submissions
    FOR EACH ROW
    EXECUTE PROCEDURE update_updated_at_column();


-- -----------------------------------------------------------------------------
-- Table: partner_inquiries
-- Handles data from PartnerInquiryForm.tsx
-- -----------------------------------------------------------------------------
CREATE TABLE IF NOT EXISTS partner_inquiries (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Partner Details
    full_name TEXT NOT NULL,
    email TEXT NOT NULL,
    organization TEXT NOT NULL,
    
    -- Message
    message TEXT NOT NULL,
    
    -- Metadata
    status inquiry_status NOT NULL DEFAULT 'new',
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),

    -- Constraints
    CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- Index for status filtering
CREATE INDEX IF NOT EXISTS idx_partner_status ON partner_inquiries(status);

-- Trigger for updated_at
DROP TRIGGER IF EXISTS update_partner_modtime ON partner_inquiries;
CREATE TRIGGER update_partner_modtime
    BEFORE UPDATE ON partner_inquiries
    FOR EACH ROW
    EXECUTE PROCEDURE update_updated_at_column();


-- =============================================================================
-- 4. ROW LEVEL SECURITY (RLS)
-- Secure tables by default.
-- =============================================================================

-- Enable RLS
ALTER TABLE waitlist_submissions ENABLE ROW LEVEL SECURITY;
ALTER TABLE partner_inquiries ENABLE ROW LEVEL SECURITY;

-- -----------------------------------------------------------------------------
-- Policies for: waitlist_submissions
-- -----------------------------------------------------------------------------

-- 1. Public Insert: Allow anyone (anon) to sign up
-- Note: Policy creation needs existence check or drop first.
DROP POLICY IF EXISTS "Public can join waitlist" ON waitlist_submissions;
CREATE POLICY "Public can join waitlist"
ON waitlist_submissions FOR INSERT
TO anon
WITH CHECK (true);

-- -----------------------------------------------------------------------------
-- Policies for: partner_inquiries
-- -----------------------------------------------------------------------------

-- 1. Public Insert: Allow anyone to submit inquiry
DROP POLICY IF EXISTS "Public can submit inquiry" ON partner_inquiries;
CREATE POLICY "Public can submit inquiry"
ON partner_inquiries FOR INSERT
TO anon
WITH CHECK (true);
